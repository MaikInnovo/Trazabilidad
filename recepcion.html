<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Registro de materiales (Empaque y MP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Librería QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
  <style>
    :root { --pri:#0d6efd; --sec:#6c757d; --ok:#0a7f2e; --err:#b71c1c; --bg:#f6f7fb; --card:#fff; --muted:#657082; }
    *{box-sizing:border-box}
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: var(--bg); color: #222; }
    .shell { max-width: 1100px; margin: 0 auto; padding: 28px 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 12px; }
    header h1 { font-size: 22px; margin:0; }
    a.back { color: var(--pri); text-decoration:none; font-weight:700; }
    .cards { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 980px) { .cards { grid-template-columns: 1fr; } }
    .card { background: var(--card); border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 8px 20px rgba(0,0,0,.05); }
    h2 { font-size:18px; margin: 0 0 6px; }
    .muted { color: var(--muted); font-size: 14px; margin: 0 0 12px; }
    .row { display:grid; grid-template-columns: repeat(12, 1fr); gap: 10px; }
    .col-12{grid-column: span 12}.col-6{grid-column: span 6}.col-4{grid-column: span 4}.col-3{grid-column: span 3}
    label { font-weight: 700; font-size: 13px; display:block; margin: 8px 0 6px; }
    input, select { width: 100%; padding: 10px 12px; border: 1px solid #cfd6e4; border-radius: 10px; background:#fff; }
    .help { font-size:12px; color: var(--muted); margin-top: 2px; }
    .btns { display:flex; gap:10px; margin-top: 12px; flex-wrap:wrap }
    button { padding: 10px 14px; border: 0; border-radius: 10px; background: var(--pri); color:#fff; font-weight: 800; cursor: pointer; }
    button.secondary { background: var(--sec); }
    .status { margin-top: 8px; font-weight:700; }
    .ok { color: var(--ok); } .err { color: var(--err); }

    /* Etiqueta */
    .label {
      width: 90mm; height: 50mm; border: 1px solid #000; padding: 6mm; box-sizing: border-box;
      display: inline-flex; justify-content: space-between; align-items: flex-start; background:#fff;
    }
    .text { font-size: 12pt; line-height: 1.2; max-width: 60%; }
    .title { font-size: 14pt; font-weight: bold; margin-bottom: 6px; }
    .small { font-size: 10pt; color: #333; }
    .qr { width: 35mm; height: 35mm; }

    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <h1>Registro de materiales</h1>
      <a class="back" href="./index.html">← Volver al inicio</a>
    </header>

    <div class="cards">
      <!-- Empaque -->
      <div class="card">
        <h2>Empaque</h2>
        <p class="muted">Selecciona tipo y fecha; el sistema calcula el día juliano y genera el lote automáticamente.</p>
        <div class="row">
          <div class="col-6">
            <label>Tipo de material</label>
            <select id="emp_tipo">
              <option value="01">01 - Cartones de huevo</option>
              <option value="02">02 - Plástico de paletizar</option>
              <option value="03">03 - Corrugado Mayca</option>
              <option value="04">04 - Corrugado Belca Logo</option>
              <option value="05">05 - Corrugado Belca Lisa</option>
              <option value="06">06 - Bandeja 30 huevos Azul</option>
              <option value="07">07 - Bandeja 30 huevos Verde</option>
              <option value="08">08 - Bandeja 4x3 huevos</option>
              <option value="09">09 - Etiquetas</option>
              <option value="10">10 - Cintillos</option>
              <option value="11">11 - Plástico de Alimentos</option>
              <option value="12">12 - Tapas de bandejas</option>
              <option value="13">13 - Porta huevos plástica1</option>
            </select>
          </div>
          <div class="col-6">
            <label>Fecha de origen</label>
            <input type="date" id="emp_fecha">
            <div class="help">Se usará para calcular el día juliano y el año.</div>
          </div>

          <div class="col-4">
            <label>Lote generado (compacto)</label>
            <input id="emp_lote" readonly placeholder="p. ej. 0114525">
          </div>
          <div class="col-4">
            <label>Día juliano</label>
            <input id="emp_jul" readonly>
          </div>
          <div class="col-4">
            <label>Año (2 dígitos)</label>
            <input id="emp_aa" readonly>
          </div>

          <div class="col-4">
            <label>Proveedor</label>
            <input id="emp_prov" placeholder="Proveedor S.A.">
          </div>
          <div class="col-4">
            <label>Cantidad</label>
            <input id="emp_qty" type="number" step="0.01" placeholder="100">
          </div>
          <div class="col-4">
            <label>Unidad</label>
            <input id="emp_unit" placeholder="pzas, cajas...">
          </div>
          <div class="col-12">
            <label>Ubicación</label>
            <input id="emp_loc" placeholder="Almacén A1">
          </div>
          <div class="col-12">
            <div id="emp_status" class="status"></div>
          </div>
        </div>
        <div class="btns">
          <button id="emp_guardar">Guardar</button>
          <button class="secondary" id="emp_imprimir">Imprimir etiqueta</button>
        </div>
      </div>

      <!-- MP genérico (sin LP) -->
      <div class="card">
        <h2>Materia Prima (Huevos)</h2>
        <p class="muted">Escribe el lote de MP y, si deseas, selecciona la fecha. El QR y la etiqueta se actualizan.</p>
        <div class="row">
          <div class="col-6">
            <label>Lote MP</label>
            <input id="mp_lote" placeholder="ABC-123-XYZ">
            <div class="help">Acepta letras, números y guiones (2 a 30 caracteres).</div>
          </div>
          <div class="col-6">
            <label>Fecha (opcional)</label>
            <input type="date" id="mp_fecha">
          </div>
          <div class="col-4">
            <label>Cartones</label>
            <input id="mp_cart" type="number" step="1" placeholder="100">
          </div>
          <div class="col-4">
            <label>Peso total (kg)</label>
            <input id="mp_peso" type="number" step="0.01" placeholder="1200">
          </div>
          <div class="col-4">
            <label>Tara (kg) opcional</label>
            <input id="mp_tara" type="number" step="0.01" placeholder="10">
          </div>
          <div class="col-12">
            <label>Ubicación</label>
            <input id="mp_loc" placeholder="Frigorífico 1">
          </div>
          <div class="col-12">
            <div id="mp_status" class="status"></div>
          </div>
        </div>
        <div class="btns">
          <button id="mp_guardar">Guardar</button>
          <button class="secondary" id="mp_imprimir">Imprimir etiqueta</button>
        </div>
      </div>
    </div>

    <!-- Vista previa e impresión -->
    <div class="card" style="margin-top:16px">
      <h2>Vista previa de etiqueta</h2>
      <p class="muted">Se actualiza automáticamente cuando completas los campos.</p>
      <div id="printArea">
        <div class="label" id="labelEmp" style="display:none">
          <div class="text">
            <div class="title" id="emp_mat_title">Material: -</div>
            <div id="emp_lote_show">Lote: -</div>
            <div class="small" id="emp_origen">Origen (juliano): -</div>
          </div>
          <div class="qr" id="emp_qr"></div>
        </div>

        <div class="label" id="labelMP" style="display:none">
          <div class="text">
            <div class="title">MP: Huevo</div>
            <div id="mp_lote_show">Lote: -</div>
            <div class="small" id="mp_fecha_show">Fecha: -</div>
          </div>
          <div class="qr" id="mp_qr"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Config API backend
    const API_BASE = "http://PCMAIKOL.INNOVOCR.COM:3000";
    const API_KEY = "TuClaveLarga_Con_Simbolos123!";
  </script>

  <script>
    // Catálogo Empaque
    const CAT = {
      "01": "Cartones de huevo",
      "02": "Plástico de paletizar",
      "03": "Corrugado Mayca",
      "04": "Corrugado Belca Logo",
      "05": "Corrugado Belca Lisa",
      "06": "Bandeja 30 huevos Azul",
      "07": "Bandeja 30 huevos Verde",
      "08": "Bandeja 4x3 huevos",
      "09": "Etiquetas",
      "10": "Cintillos",
      "11": "Plástico de Alimentos",
      "12": "Tapas de bandejas",
      "13": "Porta huevos plástica1",
    };
    const $ = s => document.querySelector(s);

    // Utils
    function dayOfYear(d) {
      const start = new Date(d.getFullYear(),0,0);
      const diff = d - start;
      return Math.floor(diff / 86400000);
    }
    function pad(n, len=2){ return String(n).padStart(len,'0'); }
    function saveLS(key, item, pkField) {
      try {
        const a = JSON.parse(localStorage.getItem(key) || "[]");
        const i = a.findIndex(x => x[pkField] === item[pkField]);
        if (i >= 0) a[i] = item; else a.push(item);
        localStorage.setItem(key, JSON.stringify(a));
        return { ok: true };
      } catch (e) {
        console.error('LocalStorage error:', e);
        return { ok: false, error: e?.message || 'Error guardando en este navegador' };
      }
    }
    function isLote(val) {
      return /^[A-Z0-9-]{2,30}$/i.test((val||"").trim());
    }

    // QR helper seguro (no rompe si la librería no carga)
    function safeCreateQR(el, text) {
      try {
        el.innerHTML = "";
        // Si no existe QRCode (CDN bloqueado), mostramos el texto como fallback
        if (typeof QRCode === "undefined") {
          const pre = document.createElement("div");
          pre.style.fontSize = "10pt";
          pre.style.whiteSpace = "pre-wrap";
          pre.textContent = text;
          el.appendChild(pre);
          return;
        }
        new QRCode(el, { text, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.M });
      } catch (e) {
        el.innerHTML = "";
        const pre = document.createElement("div");
        pre.style.fontSize = "10pt";
        pre.style.whiteSpace = "pre-wrap";
        pre.textContent = text;
        el.appendChild(pre);
      }
    }


    // Empaque: calcular lote al cambiar tipo/fecha
    function refreshEmpaque() {
      const tipo = $("#emp_tipo").value;
      const desc = CAT[tipo];
      const fstr = $("#emp_fecha").value;
      if (!fstr) {
        $("#emp_lote").value = ""; $("#emp_jul").value=""; $("#emp_aa").value="";
        $("#labelEmp").style.display = "none";
        return;
      }
      const d = new Date(fstr + "T00:00:00");
      const jul = dayOfYear(d);
      const aa = String(d.getFullYear()).slice(2);
      const lote = `${tipo}${pad(jul,3)}${aa}`;
      $("#emp_lote").value = lote;
      $("#emp_jul").value = pad(jul,3);
      $("#emp_aa").value = aa;

      // Render etiqueta y QR
      $("#labelMP").style.display = "none";
      $("#labelEmp").style.display = "";
      $("#emp_mat_title").textContent = `Material: ${desc} (${tipo})`;
      $("#emp_lote_show").textContent = `Lote: ${lote}`;
      $("#emp_origen").textContent = `Origen (juliano): ${pad(jul,3)}/20${aa}`;
      const payload = `(10)${lote}(91)${tipo}|${desc}`;
      safeCreateQR($("#emp_qr"), payload);
    }
    $("#emp_tipo").addEventListener("change", refreshEmpaque);
    $("#emp_fecha").addEventListener("change", refreshEmpaque);

    $("#emp_guardar").addEventListener("click", () => {
      const tipo = $("#emp_tipo").value;
      const desc = CAT[tipo];
      const fstr = $("#emp_fecha").value;
      if (!fstr) { $("#emp_status").innerHTML = `<span class="err">Selecciona una fecha</span>`; return; }
      const d = new Date(fstr + "T00:00:00");
      const jul = pad(dayOfYear(d),3);
      const aa = String(d.getFullYear()).slice(2);
      const lote = `${tipo}${jul}${aa}`;
      const item = {
        id_compacto: lote,
        id_canonico: `${tipo}-${jul}-${aa}`,
        tipo, descripcion_tipo: desc,
        juliano: jul, aa, fecha_aprox: `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`,
        proveedor: $("#emp_prov").value || null,
        cantidad: parseFloat($("#emp_qty").value || "0"),
        unidad: $("#emp_unit").value || null,
        ubicacion: $("#emp_loc").value || null,
        ts: new Date().toISOString(), estado: "liberado"
      };
      (async () => {
        try {
          await fetch(`${API_BASE}/api/inventarioEmpaque`, {
            method: "POST",
            headers: { "Content-Type":"application/json", "x-api-key": API_KEY },
            body: JSON.stringify(item)
          });
          $("#emp_status").innerHTML = `<span class="ok">Guardado</span> Lote ${lote} — ${desc}. Ya está en Inventario (Servidor).`;
        } catch (err) {
          $("#emp_status").innerHTML = `<span class="err">Error guardando en servidor:</span> ${err.message}`;
        }
      })();
    });

    $("#emp_imprimir").addEventListener("click", () => {
      if (!$("#emp_lote").value) { $("#emp_status").innerHTML = `<span class="err">Completa tipo y fecha</span>`; return; }
      window.print();
    });

    // MP genérico (sin LP)
    function updateMPPreview() {
      const lote = ($("#mp_lote").value || "").trim().toUpperCase();
      const fstr = $("#mp_fecha").value || "";
      if (!isLote(lote)) {
        $("#labelMP").style.display = "none";
        return;
      }
      $("#labelEmp").style.display = "none";
      $("#labelMP").style.display = "";
      $("#mp_lote_show").textContent = `Lote: ${lote}`;
      $("#mp_fecha_show").textContent = fstr ? `Fecha: ${fstr}` : "Fecha: -";

      // QR payload: (10)Lote y opcionalmente (11)AAMMDD si hay fecha
      let payload = `(10)${lote}`;
      if (fstr) {
        const d = new Date(fstr + "T00:00:00");
        const aa = String(d.getFullYear()).slice(2);
        const mm = pad(d.getMonth()+1);
        const dd = pad(d.getDate());
        payload += `(11)${aa}${mm}${dd}`;
      }
      safeCreateQR($("#mp_qr"), payload);
    }
    $("#mp_lote").addEventListener("input", updateMPPreview);
    $("#mp_fecha").addEventListener("change", updateMPPreview);

    $("#mp_guardar").addEventListener("click", () => {
      const lote = ($("#mp_lote").value || "").trim().toUpperCase();
      if (!isLote(lote)) { $("#mp_status").innerHTML = `<span class="err">Lote inválido. Usa 2 a 30 caracteres alfanuméricos o guiones</span>`; return; }
      const fstr = $("#mp_fecha").value || null;
      const cart = parseInt($("#mp_cart").value || "0", 10);
      const peso = parseFloat($("#mp_peso").value || "0");
      const tara = parseFloat($("#mp_tara").value || "0");
      const neto = Math.max(0,(peso||0)-(tara||0));
      const item = {
        id_lote_mp: lote,
        fecha: fstr,
        cartones: cart, peso_total_kg: peso||0, tara_kg: tara||0, neto_kg: neto,
        ubicacion: $("#mp_loc").value || null, ts: new Date().toISOString(), estado:"liberado"
      };
      (async () => {
        try {
          await fetch(`${API_BASE}/api/inventarioMP`, {
            method: "POST",
            headers: { "Content-Type":"application/json", "x-api-key": API_KEY },
            body: JSON.stringify(item)
          });
          $("#mp_status").innerHTML = `<span class="ok">Guardado</span> ${item.id_lote_mp} — Cartones: ${item.cartones} — Neto: ${item.neto_kg} kg. Inventario (Servidor).`;
          updateMPPreview();
        } catch (err) {
          $("#mp_status").innerHTML = `<span class="err">Error guardando en servidor:</span> ${err.message}`;
        }
      })();
    });

    $("#mp_imprimir").addEventListener("click", () => {
      const lote = ($("#mp_lote").value || "").trim();
      if (!isLote(lote)) { $("#mp_status").innerHTML = `<span class="err">Completa un lote válido para imprimir</span>`; return; }
      window.print();
    });

    // Inicial: set hoy para empaque
    document.addEventListener("DOMContentLoaded", () => {
      const today = new Date();
      const iso = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
      $("#emp_fecha").value = iso; refreshEmpaque();
      updateMPPreview();
    });
  </script>
</body>
</html> (Recepcion)
