<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Registro de materiales</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --pri:#0d6efd; --sec:#6c757d; --ok:#0a7f2e; --err:#b71c1c; --bg:#f6f7fb; --card:#fff; --muted:#657082; }
    *{box-sizing:border-box}
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: var(--bg); color: #222; }
    .shell { max-width: 800px; margin: 0 auto; padding: 28px 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 12px; }
    a.back { color: var(--pri); text-decoration:none; font-weight:700; }
    .card { background: var(--card); border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 8px 20px rgba(0,0,0,.05); margin-bottom: 16px; }
    h1 { font-size: 20px; margin:0; }
    h2 { font-size:18px; margin: 0 0 6px; }
    .muted { color: var(--muted); font-size: 14px; margin: 0 0 12px; }
    .row { display:grid; grid-template-columns: repeat(12, 1fr); gap: 10px; }
    .col-12{grid-column: span 12}.col-6{grid-column: span 6}.col-5{grid-column: span 5}.col-4{grid-column: span 4}.col-3{grid-column: span 3}
    label { font-weight: 700; font-size: 13px; display:block; margin: 8px 0 6px; }
    input, select { width: 100%; padding: 10px 12px; border: 1px solid #cfd6e4; border-radius: 10px; background:#fff; }
    .btns { display:flex; gap:10px; margin-top: 12px; flex-wrap: wrap; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; background: var(--pri); color:#fff; font-weight: 800; cursor: pointer; }
    button.secondary { background: var(--sec); }
    .status { margin-top: 6px; font-weight:700; }
    .ok { color: var(--ok); }
    .err { color: var(--err); }
    .tabs { display:flex; gap:10px; margin-bottom: 10px; }
    .tab { padding: 8px 12px; border:1px solid #cfd6e4; border-radius: 10px; background:#fff; cursor:pointer; }
    .tab.active { background: var(--pri); color:#fff; border-color: var(--pri); }
    .hidden { display:none; }
    .preview { background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-top: 10px; }
    .qr-container { text-align: center; margin: 10px 0; }
    #qr-code { margin: 0 auto; }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <h1>üì¶ Registro de materiales</h1>
      <a class="back" href="./index.html">‚Üê Volver al inicio</a>
    </header>

    <div class="card">
      <div class="tabs">
        <div id="tab_emp" class="tab active">Empaque</div>
        <div id="tab_mp" class="tab">Materia Prima</div>
      </div>

      <!-- EMPAQUE -->
      <div id="form_empaque">
        <h2>Registro de Empaque</h2>
        <p class="muted">Registra lotes de empaque (cajas, etiquetas, etc.) con su c√≥digo juliano.</p>
        <div class="row">
          <div class="col-6">
            <label>Tipo de empaque</label>
            <select id="emp_tipo">
              <option value="Caja">Caja</option>
              <option value="Etiqueta">Etiqueta</option>
              <option value="Bolsa">Bolsa</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
          <div class="col-6">
            <label>Descripci√≥n del tipo</label>
            <input id="emp_desc" placeholder="Ej. Caja 30 unidades">
          </div>
          <div class="col-4">
            <label>Juliano (DDD)</label>
            <input id="emp_juliano" placeholder="Ej. 025" maxlength="3">
          </div>
          <div class="col-4">
            <label>A√±o (AA)</label>
            <input id="emp_aa" placeholder="Ej. 25" maxlength="2">
          </div>
          <div class="col-4">
            <label>Proveedor</label>
            <input id="emp_proveedor" placeholder="Nombre del proveedor">
          </div>
          <div class="col-4">
            <label>Cantidad recibida</label>
            <input id="emp_cantidad" type="number" step="0.001" placeholder="0">
          </div>
          <div class="col-4">
            <label>Unidad</label>
            <select id="emp_unidad">
              <option value="unidades">unidades</option>
              <option value="kg">kg</option>
              <option value="cajas">cajas</option>
              <option value="rollos">rollos</option>
            </select>
          </div>
          <div class="col-4">
            <label>Ubicaci√≥n</label>
            <input id="emp_ubicacion" placeholder="Ej. Estante A-1">
          </div>
          <div class="col-12">
            <div class="btns">
              <button id="emp_guardar">Guardar</button>
              <button id="emp_preview" class="secondary">Vista previa</button>
            </div>
            <div id="emp_status" class="status"></div>
          </div>
        </div>
        <div id="emp_preview_area" class="preview hidden">
          <h3>Vista previa del lote</h3>
          <div id="emp_preview_content"></div>
          <div class="qr-container">
            <div id="emp_qr_code"></div>
          </div>
        </div>
      </div>

      <!-- MATERIA PRIMA -->
      <div id="form_mp" class="hidden">
        <h2>Registro de Materia Prima</h2>
        <p class="muted">Registra lotes de materia prima con cualquier c√≥digo alfanum√©rico.</p>
        <div class="row">
          <div class="col-6">
            <label>ID del lote</label>
            <input id="mp_lote" placeholder="Ej. ABC123, 2025-001, etc.">
          </div>
          <div class="col-6">
            <label>Fecha de recepci√≥n</label>
            <input id="mp_fecha" type="date">
          </div>
          <div class="col-4">
            <label>Cartones</label>
            <input id="mp_cartones" type="number" placeholder="0">
          </div>
          <div class="col-4">
            <label>Peso total (kg)</label>
            <input id="mp_peso_total" type="number" step="0.001" placeholder="0">
          </div>
          <div class="col-4">
            <label>Tara (kg)</label>
            <input id="mp_tara" type="number" step="0.001" placeholder="0">
          </div>
          <div class="col-6">
            <label>Ubicaci√≥n</label>
            <input id="mp_ubicacion" placeholder="Ej. C√°mara fr√≠a 1">
          </div>
          <div class="col-6">
            <label>Peso neto (kg) - Calculado</label>
            <input id="mp_neto" type="number" step="0.001" readonly>
          </div>
          <div class="col-12">
            <div class="btns">
              <button id="mp_guardar">Guardar</button>
              <button id="mp_preview" class="secondary">Vista previa</button>
            </div>
            <div id="mp_status" class="status"></div>
          </div>
        </div>
        <div id="mp_preview_area" class="preview hidden">
          <h3>Vista previa del lote</h3>
          <div id="mp_preview_content"></div>
          <div class="qr-container">
            <div id="mp_qr_code"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script>
    // Supabase REST config
    const SUPA_URL = "https://knkuchumfbertdkgjcqg.supabase.co";
    const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtua3VjaHVtZmJlcnRka2dqY3FnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NDg4MDgsImV4cCI6MjA3MDUyNDgwOH0.Fh08k3ArtSVPHY4_XeqYuszhl42GJjni9kIMXfPzAKk";

    async function supaFetch(table, method, body, query = "") {
      const url = `${SUPA_URL}/rest/v1/${table}${query}`;
      const headers = {
        apikey: SUPA_KEY,
        Authorization: `Bearer ${SUPA_KEY}`,
        "Content-Type": "application/json"
      };
      if (method === "POST" || method === "PATCH") {
        headers["Prefer"] = "resolution=merge-duplicates";
      }
      const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`HTTP ${res.status}: ${txt || res.statusText}`);
      }
      try { return await res.json(); } catch { return {}; }
    }

    // Helpers
    const $ = s => document.querySelector(s);
    function julianToDate(julian, year) {
      if (!julian || !year) return null;
      const fullYear = 2000 + parseInt(year);
      const date = new Date(fullYear, 0, parseInt(julian));
      return date.toISOString().split('T')[0];
    }
    function generateQR(text, containerId) {
      const container = $(containerId);
      container.innerHTML = "";
      if (typeof QRCode !== 'undefined') {
        QRCode.toCanvas(container, text, { width: 200, margin: 2 }, (err) => {
          if (err) container.innerHTML = `<p>Error generando QR: ${err.message}</p>`;
        });
      } else {
        container.innerHTML = `<p>QR: ${text}</p>`;
      }
    }

    // Tabs
    $("#tab_emp").addEventListener("click", () => setTab("emp"));
    $("#tab_mp").addEventListener("click", () => setTab("mp"));
    function setTab(which) {
      const empActive = which === "emp";
      $("#tab_emp").classList.toggle("active", empActive);
      $("#tab_mp").classList.toggle("active", !empActive);
      $("#form_empaque").classList.toggle("hidden", !empActive);
      $("#form_mp").classList.toggle("hidden", empActive);
    }

    // Empaque
    $("#emp_preview").addEventListener("click", () => {
      const tipo = $("#emp_tipo").value;
      const desc = $("#emp_desc").value;
      const juliano = $("#emp_juliano").value;
      const aa = $("#emp_aa").value;
      const proveedor = $("#emp_proveedor").value;
      const cantidad = $("#emp_cantidad").value;
      const unidad = $("#emp_unidad").value;
      const ubicacion = $("#emp_ubicacion").value;

      if (!tipo || !juliano || !aa) {
        alert("Completa al menos tipo, juliano y a√±o");
        return;
      }

      const lote = `${juliano}${aa}`;
      const fechaAprox = julianToDate(juliano, aa);
      const qrData = JSON.stringify({
        tipo: "empaque",
        lote,
        descripcion: `${tipo} - ${desc}`,
        fecha: fechaAprox,
        proveedor,
        cantidad: parseFloat(cantidad) || 0,
        unidad
      });

      $("#emp_preview_content").innerHTML = `
        <p><strong>Lote:</strong> ${lote}</p>
        <p><strong>Tipo:</strong> ${tipo}</p>
        <p><strong>Descripci√≥n:</strong> ${desc}</p>
        <p><strong>Fecha aprox:</strong> ${fechaAprox || "No calculada"}</p>
        <p><strong>Proveedor:</strong> ${proveedor}</p>
        <p><strong>Cantidad:</strong> ${cantidad} ${unidad}</p>
        <p><strong>Ubicaci√≥n:</strong> ${ubicacion}</p>
      `;
      generateQR(qrData, "#emp_qr_code");
      $("#emp_preview_area").classList.remove("hidden");
    });

    $("#emp_guardar").addEventListener("click", async () => {
      const tipo = $("#emp_tipo").value;
      const desc = $("#emp_desc").value;
      const juliano = $("#emp_juliano").value;
      const aa = $("#emp_aa").value;
      const proveedor = $("#emp_proveedor").value;
      const cantidad = parseFloat($("#emp_cantidad").value) || 0;
      const unidad = $("#emp_unidad").value;
      const ubicacion = $("#emp_ubicacion").value;

      if (!tipo || !juliano || !aa) {
        $("#emp_status").innerHTML = `<span class="err">Completa al menos tipo, juliano y a√±o</span>`;
        return;
      }

      const lote = `${juliano}${aa}`;
      const fechaAprox = julianToDate(juliano, aa);
      const item = {
        id_compacto: lote,
        id_canonico: `${tipo.toLowerCase()}-${lote}`,
        tipo,
        descripcion_tipo: desc,
        juliano,
        aa,
        fecha_aprox: fechaAprox,
        proveedor,
        cantidad,
        unidad,
        ubicacion,
        estado: "activo"
      };

      try {
        await supaFetch("inventario_empaque", "POST", [item]);
        $("#emp_status").innerHTML = `<span class="ok">Guardado</span> Lote ${lote} ‚Äî ${desc}. Inventario (Supabase).`;
        // Limpiar form
        $("#emp_desc").value = ""; $("#emp_juliano").value = ""; $("#emp_aa").value = "";
        $("#emp_proveedor").value = ""; $("#emp_cantidad").value = ""; $("#emp_ubicacion").value = "";
        $("#emp_preview_area").classList.add("hidden");
      } catch (e) {
        $("#emp_status").innerHTML = `<span class="err">Error guardando en Supabase: ${e.message}</span>`;
      }
    });

    // MP
    $("#mp_peso_total, #mp_tara").addEventListener("input", () => {
      const total = parseFloat($("#mp_peso_total").value) || 0;
      const tara = parseFloat($("#mp_tara").value) || 0;
      $("#mp_neto").value = (total - tara).toFixed(3);
    });

    $("#mp_preview").addEventListener("click", () => {
      const lote = $("#mp_lote").value;
      const fecha = $("#mp_fecha").value;
      const cartones = parseInt($("#mp_cartones").value) || 0;
      const pesoTotal = parseFloat($("#mp_peso_total").value) || 0;
      const tara = parseFloat($("#mp_tara").value) || 0;
      const neto = pesoTotal - tara;
      const ubicacion = $("#mp_ubicacion").value;

      if (!lote) {
        alert("Ingresa el ID del lote");
        return;
      }

      const qrData = JSON.stringify({
        tipo: "mp",
        lote,
        fecha,
        cartones,
        neto_kg: neto,
        ubicacion
      });

      $("#mp_preview_content").innerHTML = `
        <p><strong>Lote:</strong> ${lote}</p>
        <p><strong>Fecha:</strong> ${fecha}</p>
        <p><strong>Cartones:</strong> ${cartones}</p>
        <p><strong>Peso total:</strong> ${pesoTotal} kg</p>
        <p><strong>Tara:</strong> ${tara} kg</p>
        <p><strong>Neto:</strong> ${neto.toFixed(3)} kg</p>
        <p><strong>Ubicaci√≥n:</strong> ${ubicacion}</p>
      `;
      generateQR(qrData, "#mp_qr_code");
      $("#mp_preview_area").classList.remove("hidden");
    });

    $("#mp_guardar").addEventListener("click", async () => {
      const lote = $("#mp_lote").value;
      const fecha = $("#mp_fecha").value;
      const cartones = parseInt($("#mp_cartones").value) || 0;
      const pesoTotal = parseFloat($("#mp_peso_total").value) || 0;
      const tara = parseFloat($("#mp_tara").value) || 0;
      const neto = pesoTotal - tara;
      const ubicacion = $("#mp_ubicacion").value;

      if (!lote) {
        $("#mp_status").innerHTML = `<span class="err">Ingresa el ID del lote</span>`;
        return;
      }

      const item = {
        id_lote_mp: lote,
        fecha,
        cartones,
        peso_total_kg: pesoTotal,
        tara_kg: tara,
        neto_kg: neto,
        ubicacion,
        estado: "activo"
      };

      try {
        await supaFetch("inventario_mp", "POST", [item]);
        $("#mp_status").innerHTML = `<span class="ok">Guardado</span> ${item.id_lote_mp} ‚Äî Cartones: ${item.cartones} ‚Äî Neto: ${item.neto_kg} kg. Inventario (Supabase).`;
        // Limpiar form
        $("#mp_lote").value = ""; $("#mp_fecha").value = ""; $("#mp_cartones").value = "";
        $("#mp_peso_total").value = ""; $("#mp_tara").value = ""; $("#mp_neto").value = "";
        $("#mp_ubicacion").value = "";
        $("#mp_preview_area").classList.add("hidden");
      } catch (e) {
        $("#mp_status").innerHTML = `<span class="err">Error guardando en Supabase: ${e.message}</span>`;
      }
    });

    // Fecha por defecto
    document.addEventListener("DOMContentLoaded", () => {
      $("#mp_fecha").value = new Date().toISOString().split('T')[0];
    });
  </script>
</body>
</html>
