<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Realizar Empaque (Consumo de lotes)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Esc√°ner QR (opcional). La app funciona sin esto. -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.9/html5-qrcode.min.js" defer></script>
  <style>
    :root { --pri:#0d6efd; --sec:#6c757d; --ok:#0a7f2e; --err:#b71c1c; --bg:#f6f7fb; --card:#fff; --muted:#657082; }
    *{box-sizing:border-box}
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: var(--bg); color: #222; }
    .shell { max-width: 1100px; margin: 0 auto; padding: 28px 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 12px; }
    a.back { color: var(--pri); text-decoration:none; font-weight:700; }
    .cards { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 980px) { .cards { grid-template-columns: 1fr; } }
    .card { background: var(--card); border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 8px 20px rgba(0,0,0,.05); }
    h1 { font-size: 20px; margin:0; }
    h2 { font-size:18px; margin: 0 0 6px; }
    .muted { color: var(--muted); font-size: 14px; margin: 0 0 12px; }
    .row { display:grid; grid-template-columns: repeat(12, 1fr); gap: 10px; }
    .col-12{grid-column: span 12}.col-10{grid-column: span 10}.col-8{grid-column: span 8}.col-6{grid-column: span 6}.col-4{grid-column: span 4}.col-3{grid-column: span 3}.col-2{grid-column: span 2}
    label { font-weight: 700; font-size: 13px; display:block; margin: 8px 0 6px; }
    input, select { width: 100%; padding: 10px 12px; border: 1px solid #cfd6e4; border-radius: 10px; background:#fff; }
    .btns { display:flex; gap:10px; margin-top: 12px; flex-wrap: wrap; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; background: var(--pri); color:#fff; font-weight: 800; cursor: pointer; }
    button.secondary { background: var(--sec); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .status { margin-top: 8px; font-weight:700; }
    .ok { color: var(--ok); } .err { color: var(--err); }
    table { width:100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; text-align: left; }
    .scanbox { border:1px solid #d1d5db; border-radius:10px; padding:10px; background:#fff; }
    .disabled-mask { position: relative; }
    .disabled-mask::after {
      content:"Inicia el pedido para capturar consumos";
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,0.65); color:#444; font-weight:700; border-radius: 12px; text-align:center; padding: 8px;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <h1>üè≠ Realizar Empaque (consumo de lotes)</h1>
      <a class="back" href="./index.html">‚Üê Volver al inicio</a>
    </header>

    <div class="card">
      <h2>Pedido / Lote final</h2>
      <p class="muted">Define el ID de pedido/lote final y a qui√©n va destinado.</p>
      <div class="row">
        <div class="col-4">
          <label>ID Pedido / Lote Final</label>
          <input id="pf_lote" placeholder="Ej. 2025-0811-01 o ABC123">
        </div>
        <div class="col-3">
          <label>Fecha</label>
          <input id="pf_fecha" type="date">
        </div>
        <div class="col-5">
          <label>Cliente destino</label>
          <input id="pf_cliente" placeholder="Cliente S.A. / Sucursal">
        </div>
        <div class="col-6">
          <label>Responsable</label>
          <input id="pf_resp" placeholder="Operador">
        </div>
      </div>
      <div class="btns">
        <button id="pf_iniciar">Iniciar Pedido</button>
        <div id="pf_status" class="status"></div>
      </div>
    </div>

    <div id="consumos_wrap" class="cards disabled-mask">
      <div class="card">
        <h2>Agregar consumo</h2>
        <p class="muted">Escanea o escribe el lote, indica cantidad y tipo de consumo.</p>
        <div class="row">
          <div class="col-12">
            <div id="scanBOX" class="scanbox">
              <div class="btns">
                <button id="scan_btn">Escanear QR</button>
                <button class="secondary" id="scan_stop" disabled>Detener</button>
              </div>
              <div id="qr_reader" style="width:100%; max-width:420px; margin-top:8px;"></div>
              <div id="scan_status" class="muted"></div>
            </div>
          </div>

          <div class="col-6">
            <label>Lote</label>
            <input id="c_lote" placeholder="Ej. ABC123 o 01-145-25">
          </div>
          <div class="col-3">
            <label>Cantidad</label>
            <input id="c_qty" type="number" step="0.01" placeholder="100">
          </div>
          <div class="col-3">
            <label>Tipo</label>
            <select id="c_tipo">
              <option value="MP">MP</option>
              <option value="Empaque">Empaque</option>
            </select>
          </div>
          <div class="col-12">
            <div class="btns">
              <button id="c_agregar">Agregar consumo</button>
              <div id="c_status" class="status"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Detalle de consumos</h2>
        <table id="tabla">
          <thead>
            <tr><th>Tipo</th><th>Lote</th><th>Cantidad</th><th>Unidad</th><th>Fecha</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="btns">
          <button id="pf_guardar">Guardar todo</button>
          <div id="save_status" class="status"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Helpers
    const $ = s => document.querySelector(s);
    const nowISO = () => new Date().toISOString();
    const hasScanner = () => typeof window.Html5Qrcode !== "undefined";

    function saveLS(key, item, pkField) {
      const a = JSON.parse(localStorage.getItem(key) || "[]");
      const i = a.findIndex(x => x[pkField] === item[pkField]);
      if (i >= 0) a[i] = item; else a.push(item);
      localStorage.setItem(key, JSON.stringify(a));
    }
    function pushLS(key, item) {
      const a = JSON.parse(localStorage.getItem(key) || "[]");
      a.push(item); localStorage.setItem(key, JSON.stringify(a));
    }

    // Validaci√≥n gen√©rica de lote: alfanum√©rico/h√≠fen, 2..30 chars
    function isLote(val) {
      return /^[A-Z0-9-]{2,30}$/i.test((val||"").trim());
    }

    // Estado
    const state = { pf: null, renglones: [], scanners: { inst: null } };

    function setConsumosEnabled(enabled) {
      const wrap = $("#consumos_wrap");
      if (enabled) {
        wrap.classList.remove("disabled-mask");
        wrap.querySelectorAll("input, select, button").forEach(el => {
          if (el.id !== "scan_stop") el.disabled = false;
        });
      } else {
        wrap.classList.add("disabled-mask");
        wrap.querySelectorAll("input, select, button").forEach(el => el.disabled = true);
      }
    }

    // Iniciar pedido
    $("#pf_iniciar").addEventListener("click", () => {
      const id = $("#pf_lote").value.trim();
      const fecha = $("#pf_fecha").value;
      const resp = ($("#pf_resp").value || "").trim() || null;
      const cliente = ($("#pf_cliente").value || "").trim() || null;
      if (!id) { $("#pf_status").innerHTML = '<span class="err">Define el ID de pedido/lote final</span>'; return; }
      if (!fecha) { $("#pf_status").innerHTML = '<span class="err">Selecciona la fecha</span>'; return; }

      state.pf = { id_lote_pf: id, fecha, responsable: resp, cliente_destino: cliente, estado: "en_proceso", ts: nowISO() };
      $("#pf_status").innerHTML = '<span class="ok">Pedido iniciado</span>';
      setConsumosEnabled(true);
    });

    // Agregar consumo
    $("#c_agregar").addEventListener("click", () => {
      if (!state.pf) { $("#c_status").innerHTML = '<span class="err">Inicia el pedido primero</span>'; return; }
      const lote = ($("#c_lote").value || "").trim().toUpperCase();
      const qty = parseFloat($("#c_qty").value || "0");
      const tipo = $("#c_tipo").value;
      if (!isLote(lote)) { $("#c_status").innerHTML = '<span class="err">Lote inv√°lido</span>'; return; }
      if (!(qty > 0)) { $("#c_status").innerHTML = '<span class="err">Ingresa cantidad > 0</span>'; return; }
      const unidad = tipo === "Empaque" ? "pzas/cajas" : "kg/cartones";
      const row = { tipo, id_lote: lote.replace(/\s+/g,''), cantidad: qty, unidad, ts: nowISO() };
      state.renglones.push(row); renderTable();
      $("#c_status").innerHTML = '<span class="ok">Agregado</span>'; $("#c_lote").value = ""; $("#c_qty").value="";
    });

    function renderTable() {
      const tb = document.querySelector("#tabla tbody");
      tb.innerHTML = "";
      state.renglones.forEach((r, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.tipo}</td>
          <td>${r.id_lote}</td>
          <td>${r.cantidad}</td>
          <td>${r.unidad}</td>
          <td>${new Date(r.ts).toLocaleString()}</td>
          <td><button data-i="${idx}" class="secondary">Quitar</button></td>
        `;
        tb.appendChild(tr);
      });
      tb.querySelectorAll("button.secondary").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const i = parseInt(e.target.getAttribute("data-i"), 10);
          state.renglones.splice(i,1); renderTable();
        });
      });
    }

    // Guardar todo
    $("#pf_guardar").addEventListener("click", () => {
      if (!state.pf) { $("#save_status").innerHTML = '<span class="err">Inicia el pedido</span>'; return; }
      if (state.renglones.length === 0) { $("#save_status").innerHTML = '<span class="err">Agrega al menos un consumo</span>'; return; }

      const pf = { ...state.pf, estado: "cerrado", ts_cierre: nowISO() };
      saveLS("lotesPF", pf, "id_lote_pf");

      // Guarda consumos separados por tipo
      state.renglones.forEach(r => {
        if (r.tipo === "MP") {
          pushLS("consumosMP", { id_lote_pf: pf.id_lote_pf, id_lote_mp: r.id_lote, cantidad: r.cantidad, unidad: r.unidad, ts: r.ts });
        } else {
          pushLS("consumosEmpaque", { id_lote_pf: pf.id_lote_pf, id_lote_empaque: r.id_lote, cantidad: r.cantidad, unidad: r.unidad, ts: r.ts });
        }
      });

      // Reset
      state.pf = null; state.renglones = []; renderTable();
      $("#pf_lote").value=""; $("#pf_fecha").value=""; $("#pf_resp").value=""; $("#pf_cliente").value="";
      setConsumosEnabled(false);
      $("#save_status").innerHTML = '<span class="ok">Guardado. Pedido y consumos registrados</span>';
    });

    // Esc√°ner QR
    let scanner = null;
    function startScanner(domId, onScan, onError) {
      const inst = new Html5Qrcode(domId);
      inst.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
        (decoded) => onScan(decoded),
        (err) => onError && onError(err)
      );
      return inst;
    }

    $("#scan_btn").addEventListener("click", () => {
      if (!hasScanner()) {
        $("#scan_status").textContent = "No hay esc√°ner disponible. Ingresa el lote manualmente.";
        return;
      }
      if (scanner) return;
      $("#scan_stop").disabled = false;
      $("#scan_status").textContent = "Escaneando... apunta la c√°mara al QR";
      scanner = startScanner("qr_reader", (txt) => {
        // Si viene con (10)xxxxxxxx, usamos ese valor. Si no, usamos el texto completo.
        const m = (txt||"").match(/\(10\)([^\(\)]+?)(?:\(|$)/);
        const val = m ? m[1] : (txt||"");
        $("#c_lote").value = String(val).trim().toUpperCase();
        $("#scan_status").textContent = "QR le√≠do";
      }, (err) => {});
    });

    $("#scan_stop").addEventListener("click", () => {
      if (scanner) { scanner.stop(); scanner.clear(); scanner=null; }
      $("#scan_stop").disabled = true;
      $("#scan_status").textContent = "";
    });

    // Inicial
    document.addEventListener("DOMContentLoaded", () => {
      const today = new Date();
      const iso = today.toISOString().slice(0,10);
      $("#pf_fecha").value = iso;
      setConsumosEnabled(false);
    });
  </script>
</body>
</html>
